require "json"
require "uuid"

class Arml
  module Role
    module Storable
      module ClassMethods
        def load(key)
					result = EM::Synchrony.sync coll.find_one({:_id => key})
          return self.new(result)
        end
      end

      def self.included includer
        includer.extend ClassMethods
      end

			def coll
				return Arml.db.collection(key)
			end

      def key
        return db_key
      end

      def save
        mykey = key
				if (_id)
					return db_update
				else
					return db_insert
				end
      end

			def db_insert
				newid = coll.insert(to_h)
				return self.send(:load, newid.to_s)
			end

			def db_update
				coll.update({_id: _id}, to_h)
			end
    end
  end
end
